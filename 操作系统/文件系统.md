# 文件系统

文件系统提供了从存储块到适合应用程序使用的数据结构的一种抽象

信息结构;

~~~flow
st=>start: 应用
1=>operation: 结构化记录文件
2=>operation: 记录-流 转换
3=>operation: 字节流文件
4=>operation: 流-块 转换
e=>end: 存储器
st->1->2->3->4->e
~~~

windows,unix 只提供了流块转换,是一种==低级文件系统==

提供了==记录-流转换==的文件系统是一种==高级文件系统==













## 目录管理

- 目录管理的要求

- 使用文件控制块保存信息

- 使用索引节点查找文件

#### 目录结构

- 单级结构

  ​	所有的用户共用一个文件目录表

  ​	文件名唯一,查找速度慢,不便于文件共享

- 两级结构

  为每一个用户建立一个文件目录表UFD(user file directory)

  查找文件时只查找用户自己的文件目录表

- 多级目录

  现代操作系统的的目录结构

  文件路径分为 相对路径和绝对路径

  ~/user/temp

  temp

  目录表项既可以是目录文件FCB 也可以是 数据文件 FCB



#### 目录查询

**用户访问文件时,按照给出的文件名在文件目录表中查找,找到对应的文件控制块(FCB)或者索引节点,拿到文件物理地址(盘块号),换算出文件在磁盘中的物理位置**

**通过磁盘驱动程序,将文件装入内存**

- 线性检索法

  按照文件名在文件目录表中顺序查找,

- hash查找

  将文件名按照hash函数映射,按照得到的索引在目录中查找

  **当使用通配符时,任然按照线性检索法**

  冲突解决 

  > 即按照hash映射的解决方法,比如说加上和目录长度互质的常数





## 文件空间分配

存储空间的分配无非是采用离散和顺序的方法,前者能有效的利用存储空间,而后者能拥有较高的访问速度

##### 空闲表法

- 分配

  为每个文件分配一块连续的存储空间

  建立一张空闲表,每个空闲区对应于一个空闲表项

- 分配和回收

  仿照内存分配,采用首次适应算法等

- **当文件过大时,采用离散分配**

##### 空闲链表法

- 空闲盘块法
- 空闲盘区法

##### 位示图

采用一个二维表表示各个盘块的使用情况,使用0,1表示盘块分配与否,将二维坐标映射为盘块号

**优点: 可以方便的找到连续的空盘块,同时由于空间占用小,可以放入内存,减少了磁盘的启动时间**

- 计算盘块号

  第i行,第j列,盘块号p,每行位数 n

  **P= n* (i - 1) + j**

- 盘块回收

  I = P **div** n + 1

  J = P **mod** n

##### 成组链接法

- 加锁
- 栈



## 文件共享

多个用户共享一个文件时,如果需要保存多个文件副本,是一件极其浪费存储空间的决策

#### 基于索引节点的文件共享

- 文件目录项中只存放索引节点,不存放其他信息
- 索引节点才存放物理地址和文件属性等等
- **多个用户同时拥有指向文件的索引节点**
- **如果用户对共享文件增加内容,则增加的内容及盘块只对对应用户开放**

#### 利用符号链事项文件共享

- 只有文件所有者才拥有指向索引节点的指针
- 创建一个链接文件(link),存放共享文件的路径名,
- **存放的路径名,查找开销过大**
- **如果存放了网络地址,可以实现网络共享**



## 磁盘容错技术

通过磁盘容错技术防止磁盘部分造成的文件不安全性

通过文件存取控制防止人为因素造成的文件不安全性

通过"后备系统"防止自然因素造成的不安全性

#### 第一级容错技术 SFT-I

防止磁盘表面损坏造成的数据丢失

- 双份目录,双份文件分配表

  磁盘中的表结构是磁盘数据读取的重要因素,当一份表结构损坏时,可以切换到另一张表 

- 热修复重定向

  将磁盘一部分作为热修复重定向区,当磁盘存在坏道 时,将写入该块的部分映射到重定向区

- 写后读校验

  写入数据后,立刻读取出来放入缓冲区,同时**和内存中要写入的数据**比对,如果不同,则重写磁盘

#### 第二级容错技术

防止因磁盘控制器和磁盘驱动器造成的故障

- 磁盘镜像

  一个磁盘控制器控制两个磁盘(其中一个使备份磁盘)

- 磁盘双工

  每个备份磁盘都拥有独立的磁盘控制器




~~~

~~~

~~~

~~~